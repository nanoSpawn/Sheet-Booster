<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Numeración alzada de tickets - Gràfiques Muntaner</title>

<link href='http://fonts.googleapis.com/css?family=Asap:400,700,400italic,700italic|Bree+Serif' rel='stylesheet' type='text/css'>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="js/swfobject.js"></script>
<script type="text/javascript" src="js/downloadify.min.js"></script>
<script type="text/javascript" src="http://www.muntanercomunicacio.com/FileSaver.min.js"></script>
<script type="text/javascript" src="http://www.muntanercomunicacio.com/blob.js"></script>

<style>

/*


*/
	html {
		min-width: 530px;
	}
	body {
		font-family: 'Asap', sans-serif;
		font-size: 15px;
		line-height: 1.5em;
		color: white;
		font-weight: bold;
		margin: 0;
		padding: 0;
		background: #660033;
		background-image: url('images/pattern-djwn.png');
		background-repeat: repeat;
	}
	
	input, textarea, #downloadFile {
		width: 4em;
		font-family: 'Asap', sans-serif;
		font-size: 15px;
		color: #444;
		border: none;
		padding: 2px 6px;
		-webkit-box-shadow: inset 0px 0px 5px 0px rgba(0, 0, 0, 0.35);
		-moz-box-shadow:    inset 0px 0px 5px 0px rgba(0, 0, 0, 0.35);
		box-shadow:         inset 0px 0px 5px 0px rgba(0, 0, 0, 0.35);
		-webkit-border-radius: 5px;
		-moz-border-radius: 5px;
		border-radius: 5px;
	}
	
	input[type=submit], #downloadFile {
		cursor: pointer;
		background-color: buttonface;
		width: auto;
	}

	input[type=submit]:active, #downloadFile:active {
		outline: #4D90FE;
	}
	input[type=checkbox] {
		width: auto;
	}

	#filename {
		width: 9em;
	}

	textarea {
		width: 380px;
		max-width: 380px;
		max-height: 450px;
		height: 450px;
	}

	#length, #times, #tickets_hoja {
		width: 2em;
	}
	h1 {
		font-family: 'Bree Serif', serif;
		font-size: 1.7em;
		line-height: 1em;
		color: #660033;
		width: 100%;
		border-bottom: solid 1px #ccc;	
	}

	h2 {
		font-family: 'Bree Serif', serif;
		font-size: 1.2em;
		color: #666;
		border-bottom: none;	
	}

	#container {
		display: block;
		margin: 20px auto;
		width: 920px;
		vertical-align: middle;
	}
	
	#formularies, #results {
		display: block;
		position: relative;
		float: left;
		color: #444;
		font-weight: normal;
		margin: 20px auto;
		padding: 30px;
		width: 500px;
		background: #f4f4f4;
		-webkit-box-shadow: 0px 0px 30px 3px rgba(0, 0, 0, 0.75);
		-moz-box-shadow:    0px 0px 30px 3px rgba(0, 0, 0, 0.75);
		box-shadow:         0px 0px 30px 3px rgba(0, 0, 0, 0.75);
		-webkit-border-radius: 10px;
		-moz-border-radius: 10px;
		border-radius: 10px;
	}
	
	#formularies {
		width: 400px;
		z-index: 10;
	}
	#results {
	width: 400px;
	margin-left: -100px;
	padding-left: 130px;
	z-index: 1;
		
	}

	.time {
		display: block;
		margin: 0 auto 10px auto;
		text-align: center;
		color: white;
		font-size: .6em;
		opacity: .5;
	}

	.explanation {
		font-size: .8em;
		color: #aaa;
	}

	#error {
		display: none;
		padding: 10px;
		height: 50px;
		-webkit-box-shadow: 0px 0px 10px 3px rgba(0, 0, 0, 0.35);
		-moz-box-shadow:    0px 0px 10px 3px rgba(0, 0, 0, 0.35);
		box-shadow:         0px 0px 10px 3px rgba(0, 0, 0, 0.35);
		-webkit-border-radius: 6px;
		-moz-border-radius: 6px;
		border-radius: 6px;

		color: red;
		background: white;
		font-weight: bold;

	}
	.warning {
	      font-weight: bold;
	      color: red;
	      -webkit-box-shadow: inset 0px 0px 5px 0px rgba(200, 0, 0, 0.35);
		-moz-box-shadow:    inset 0px 0px 5px 0px rgba(200, 0, 0, 0.35);
		box-shadow:         inset 0px 0px 5px 0px rgba(200, 0, 0, 0.35);
	}

	@media (max-width: 900px) {

		#container {
			width: 460px;
		}

		#results {
			padding-left: 30px;
			margin-left: 0;
			margin: 20px 0 0 0;
			float: none;
		}

		#formularies {
			margin: 0 0 20px 0;
		}
	}


</style>

<script type="text/javascript">
//Defining default values for the form

var defaultValues = '{"from":"1", "to":"100", "length":"5", "times":"2", "paged":true, "formatted":true, "filename":"numeros.xml", "tickets_hoja":"10", "number_of_elements":"0"}';
var values = jQuery.parseJSON(defaultValues);

// Function that fills the form elements with the current values
// Starting with default hardcoded values
function fillForm(values) {
  $("#from").val(values.from);
  $("#to").val(values.to);
  $("#length").val(values.length);
  $("#times").val(values.times);
  $("#filename").val(values.filename);
  $("#tickets_hoja").val(values.tickets_hoja);
  if (values.paged) {
      $("#paged").attr("checked", true).val(true);
   } else {
      $("#paged").attr("checked", false).val(false);
   }
  if (values.formatted==true) {
      $("#formatted").attr("checked", true).val(true);
   } else {
      $("#formatted").attr("checked", false).val(false);
   }
}

// Gets the form current values, returns an object
function getForm(values) {
  values.from = $("#from").val();
  values.to = $("#to").val();
  values.length = $("#length").val();
  values.times = $("#times").val();
  values.filename = $("#filename").val();
  values.tickets_hoja = $("#tickets_hoja").val();
  
  if ($("#paged").prop("checked")) {
    values.paged = true;
  }
  else {
    values.paged = false;
  }
  if ($("#formatted").prop("checked")) {
    values.formatted = true;
  }
  else {
    values.formatted = false;
  }
  
  return values;
}


// Function that generates the XML from the specified values, passed via an object
function generateXML(values) {
 
  var total_tickets = values.to - values.from + 1; // Total number of tickets to print
  var numberOfElements = total_tickets * values.times; // Total number of elements in the XML
  var hojas = Math.ceil(total_tickets / values.tickets_hoja); // Total number of sheets
  	$("#hojas").text(hojas);
	$("#numberOfElements").text(numberOfElements);	
  
  
  if (values.formatted) { // Sets the line break if formatted is true
      var $lb = "\n";
  } else {
      var $lb = "";
  }
  
  var $xml = '<?xml version="1.0"?>' + $lb + '<Root>' + $lb;
  
  if (!values.paged) { // If we don't want pages, tree will be Root->xml->n
   $xml = $xml + "<xml>" + $lb;
  }
  
  for (var $h = 1; $h <= hojas; $h++ ) { // iterating through the sheets
    if (values.paged) {
      $xml=$xml + '<page number="' + $h + '">' + $lb;
    }
    for (var $i = 0; $i < values.tickets_hoja; $i++) { // iterating through tickets
	  for (var $t = 1; $t <= values.times; $t++) { // repeating as many times as needed
	    var $j = $h + (values.from -1) + (hojas * $i);
	    $j = pad($j, values.length); //add zeroes
	    if ($j > values.to) { $j = " ";} // scrap calculated numbers bigger than the one in the "to" textbox
	    $xml =  $xml + "<n" + $t + ">" + $j + "</n" + $t + ">" + $lb;
	  }
    }
    if (values.paged) { // Closing tags if needed to.
      $xml=$xml + "</page>" + $lb;
    }
  }
  
  if (!values.paged) { // Closing tags if needed to.
    $xml = $xml + "</xml>" + $lb;
   }
  
  $xml = $xml + "</Root>" + $lb;
  $xml = $xml + "</xml>";
  
   $("#resultadoXML").val($xml);
}

function pad (str, max) { //Function that adds zeroes to the left of the number
  str=str.toString(); 
  function main(str,max){ 
    return str.length < max ? main("0" + str, max) : str; } 
    return main(str,max); 
   }

function refreshCalculatedData(values) { // Simply prints the useful data
	var total_tickets = values.to - values.from + 1; // Total number of tickets to print
	var $numberOfElements = total_tickets * values.times; // Total number of elements in the XML
	var $hojas = Math.ceil(total_tickets / values.tickets_hoja); // Total number of sheets
	
	$("#hojas").text($hojas);
	$("#numberOfElements").text($numberOfElements);	
}

$(document).ready(function(){

  fillForm(values);
  generateXML(values);
  
  $("#generador").on('submit', function() {
      if ($error) {
	event.preventDefault();
      } else {
	event.preventDefault();
	values = getForm(values);
	generateXML(values); }
  });

  $("#from").on("change", function() {
  		var val = $(this).val()
  		$("#to").attr("min", val);
  });

  $("#to").on("change", function() {
  		var val = $(this).val()
  		$("#from").attr("max", val);
  });

$("#downloadFile").on("click", function() {
		var blob = new Blob([$("#resultadoXML").val()], {type: "text/plain;charset=utf-8"});
		saveAs(blob, values.filename);
	});
});

</script>
	
</head>



<body style="font-family: Helvetica, sans-serif;">
<div id="container">
<div id="formularies">
<h1>Numeración alzada de tickets</h1>
<h2>Generador de números</h2>

<form id="generador">
	<p>De <input name="from" type="number" id="from" value="" size="10" maxlength="10" required /> 
  a <input name="to" type="number" id="to" value="" size="10" maxlength="10" required /><br />
  Longitud <input name="length" type="number" id="length" value="" size="2" maxlength="2" required min="1" max="10" /><br />
  Repetir <input name="times" type="number" id="times" value="" size="2" maxlength="2" required min="1" max="10" /> veces <br /><br />
  <h2>Impresión</h2>
  Tickets por hoja  <input name="tickets_hoja" type="number" id="tickets_hoja" value="" size="2" maxlength="2" min="1" max="100" required /><br />
  Número final de hojas (redondeado hacia arriba): <b id="hojas"></b><br /><br />
  <input type="checkbox" name="formatted" id="formatted" value="true">XML con formato<br />
  <span class="explanation">Necesario para que haya line breaks en inDesign</span><br />
  <input type="checkbox" name="paged" id="paged" value="true">XML paginado<br />
  <span class="explanation">Para separar el XML también por páginas</span><br /><br />
  <input type="submit" value="Generar XML" /><br /><br />
  <span id="error"></span>

</p>

<h2>Descarga de fichero con XML generado</h2>
<span class="explanation">Recuerda generar el XML de nuevo si has cambiado algún dato</span><br />
Nombre del archivo a descargar: <input type="text" value="" id="filename" name="filename" required /><br /><br />
<!-- <p id="downloadify">
				<i>You must have Flash 10 installed to download this file.</i>
			</p> -->
<a id="downloadFile">¡Descargar!</a>
			


</form>

<script type="text/javascript">
		/*	function load(){
				Downloadify.create('downloadify',{
					filename: function(){
						return document.getElementById('filename').value;
					},
					data: function(){ 
						return document.getElementById('resultadoXML').value;
					},
					onComplete: function(){ alert('¡Archivo guardado!'); },
					onCancel: function(){ alert('Descarga cancelada.'); },
					onError: function(){ alert('El contenido del fichero no puede ser nulo.'); },
					swf: 'media/downloadify.swf',
					downloadImage: 'images/download.png',
					width: 100,
					height: 18,
					transparent: true,
					append: false
				});
			} */
		</script>
	</div>

<div id="results">
<form>

<p><strong>XML generado        </strong> Nº de elementos: <span id="numberOfElements"></span></p>
<span class="explanation">Último XML generado, puedes hacer copy paste o guardarlo en archivo</span>

<p>
  <label for="resultadoXML"></label>
  <textarea name="resultadoXML" cols="60" rows="25" readonly id="resultadoXML"></textarea>
</p></form></div>
</div>
</body>
</html>